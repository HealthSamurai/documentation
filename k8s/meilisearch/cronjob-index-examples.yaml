apiVersion: batch/v1
kind: CronJob
metadata:
  name: meilisearch-index-examples
  namespace: gitbok
  labels:
    app.kubernetes.io/name: meilisearch
    app.kubernetes.io/component: examples-indexer
    app.kubernetes.io/part-of: documentation-search
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400  # Delete completed jobs after 24 hours
      template:
        metadata:
          labels:
            app.kubernetes.io/name: meilisearch
            app.kubernetes.io/component: examples-indexer
        spec:
          restartPolicy: OnFailure
          containers:
            - name: indexer
              image: python:3.10-slim
              command: ["/bin/bash", "-c"]
              args:
                - |
                  set -e
                  echo "Installing requests package..."
                  pip install --quiet requests
                  echo "Running indexer..."
                  python /scripts/index-examples.py
              env:
                - name: MEILISEARCH_HOST_URL
                  value: "http://meilisearch.gitbok.svc.cluster.local:7700"
                - name: MEILISEARCH_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: meilisearch-secret
                      key: master-key
                - name: GITHUB_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: github-secret
                      key: pat
              resources:
                requests:
                  memory: "128Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"
              volumeMounts:
                - name: script
                  mountPath: /scripts
                  readOnly: true
          volumes:
            - name: script
              configMap:
                name: meilisearch-examples-indexer-script
                defaultMode: 0755
