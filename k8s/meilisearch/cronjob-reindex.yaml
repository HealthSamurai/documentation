apiVersion: batch/v1
kind: CronJob
metadata:
  name: meilisearch-reindex
  namespace: gitbok
spec:
  schedule: "0 * * * *" # Every hour
  concurrencyPolicy: Forbid # Don't start new job if previous is still running
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400 # Delete jobs after 24 hours
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: docs-scraper
              image: getmeili/docs-scraper:latest
              envFrom:
                - configMapRef:
                    name: meilisearch-reindex-env
              env:
                - name: MEILISEARCH_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: meilisearch-secret
                      key: master-key
                - name: INDEX_NAME
                  value: "docs"
              volumeMounts:
                - name: config
                  mountPath: /docs-scraper/config.json
                  subPath: config.json
                - name: reindex-script
                  mountPath: /scripts
              args: ["/scripts/reindex.sh"]
          volumes:
            - name: config
              configMap:
                name: meilisearch-scraper-config
            - name: reindex-script
              configMap:
                name: meilisearch-reindex-script
                defaultMode: 0755
