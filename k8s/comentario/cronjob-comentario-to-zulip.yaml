apiVersion: batch/v1
kind: CronJob
metadata:
  name: comentario-to-zulip
  namespace: gitbok
  labels:
    app.kubernetes.io/name: comentario-poller
spec:
  # Run every 20 minutes
  schedule: "*/20 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: poller
            image: python:3.11-slim
            command:
            - python3
            - /scripts/poll-comentario.py
            env:
            - name: DB_PATH
              value: "/comentario-data/comentario.db"
            - name: COMENTARIO_DOMAIN_ID
              value: "8b8989c9-07de-4b9a-b870-ce6d3ce586c3"
            - name: COMENTARIO_BASE_URL
              value: "https://www.health-samurai.io/docs/futureblog/comentario"
            - name: ZULIP_URL
              valueFrom:
                secretKeyRef:
                  name: comentario-oauth
                  key: zulip-url
            - name: ZULIP_BOT_EMAIL
              valueFrom:
                secretKeyRef:
                  name: comentario-oauth
                  key: zulip-bot-email
            - name: ZULIP_BOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: comentario-oauth
                  key: zulip-bot-token
            volumeMounts:
            - name: script
              mountPath: /scripts
              readOnly: true
            - name: comentario-data
              mountPath: /comentario-data
              readOnly: true
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                - ALL
              runAsUser: 1000
              runAsGroup: 1000
          volumes:
          - name: script
            configMap:
              name: comentario-poller-script
              defaultMode: 0555
          - name: comentario-data
            persistentVolumeClaim:
              claimName: comentario-data
              readOnly: true
          securityContext:
            runAsNonRoot: true
            fsGroup: 1000
