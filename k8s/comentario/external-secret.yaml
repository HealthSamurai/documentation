apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: comentario-oauth
  namespace: gitbok
  labels:
    app.kubernetes.io/name: comentario
    app.kubernetes.io/component: comment-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: gcp-store
  target:
    name: comentario-oauth
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # OAuth credentials stored as secrets.yaml (YAML format)
        secrets.yaml: |
          # SQLite database
          sqlite3:
            file: /comentario-data/comentario.db

          # Identity Providers (OAuth)
          idp:
            # Google OAuth
            google:
              key: "{{ .googleClientId }}"
              secret: "{{ .googleClientSecret }}"

            # GitHub OAuth
            github:
              key: "{{ .githubClientId }}"
              secret: "{{ .githubClientSecret }}"

            # OIDC providers (LinkedIn, etc)
            oidc:
              - id: linkedin
                name: LinkedIn
                url: https://www.linkedin.com/oauth/
                scopes:
                  - openid
                  - profile
                  - email
                key: "{{ .linkedinClientId }}"
                secret: "{{ .linkedinClientSecret }}"

          # Dynamic configuration defaults
          dynamicConfigDefaults:
            domain.defaults:
              signup:
                enableFederated: true
                enableLocal: false

        # Zulip integration credentials (for CronJob polling)
        zulip-url: "{{ .zulipUrl }}"
        zulip-bot-email: "{{ .zulipBotEmail }}"
        zulip-bot-token: "{{ .zulipBotToken }}"

  data:
    # Google OAuth
    - secretKey: googleClientId
      remoteRef:
        key: comentario--google-client-id

    - secretKey: googleClientSecret
      remoteRef:
        key: comentario--google-client-secret

    # GitHub OAuth
    - secretKey: githubClientId
      remoteRef:
        key: comentario--github-client-id

    - secretKey: githubClientSecret
      remoteRef:
        key: comentario--github-client-secret

    # LinkedIn OAuth
    - secretKey: linkedinClientId
      remoteRef:
        key: comentario--linkedin-client-id

    - secretKey: linkedinClientSecret
      remoteRef:
        key: comentario--linkedin-client-secret

    # Zulip integration
    - secretKey: zulipUrl
      remoteRef:
        key: comentario--zulip-url

    - secretKey: zulipBotEmail
      remoteRef:
        key: comentario--zulip-bot-email

    - secretKey: zulipBotToken
      remoteRef:
        key: comentario--zulip-bot-token
