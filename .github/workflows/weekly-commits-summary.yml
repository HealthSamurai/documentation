name: Weekly Commits Summary

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for git log

    - name: Get commits from last week
      id: commits
      run: |
        # Check if there are any commits
        COMMIT_COUNT=$(git rev-list --count --since="7 days ago" HEAD)
        if [ "$COMMIT_COUNT" -eq 0 ]; then
          echo "No commits in the last week"
          echo "has_commits=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "has_commits=true" >> $GITHUB_OUTPUT

        # Detailed commit info with file changes
        {
          echo "## Commits this week"
          echo ""
          git log --since="7 days ago" --pretty=format:"### %s%n**Author:** %an | **Date:** %ad%n" --date=short --stat | head -500
          echo ""
          echo "## Overall stats"
          echo ""
          echo "- Total commits: $COMMIT_COUNT"
          echo ""
          echo "## Most changed files"
          git log --since="7 days ago" --pretty=format: --name-only | sort | uniq -c | sort -rn | head -15
        } > /tmp/commits.txt

        echo "Commits data collected:"
        cat /tmp/commits.txt

    - name: Install Claude Code
      if: steps.commits.outputs.has_commits == 'true'
      run: npm install -g @anthropic-ai/claude-code

    - name: Generate summary with Claude
      if: steps.commits.outputs.has_commits == 'true'
      env:
        CLAUDE_CODE_USE_BEDROCK: "0"
        ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_TOKEN }}
      run: |
        COMMITS=$(cat /tmp/commits.txt)

        claude --print "Here is detailed commit information for the last week in the documentation repository:

        $COMMITS

        Analyze this data and create a concise summary:
        1. **Key changes** - what was done, grouped by topic
        2. **Main areas** - which parts of documentation were affected the most
        3. **Stats** - brief overview of the scope of changes

        Format: markdown, concise and informative. Don't repeat raw data, extract the essence." > /tmp/summary.md

        echo "Generated summary:"
        cat /tmp/summary.md

    - name: Send to Telegram
      if: steps.commits.outputs.has_commits == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        WEEK_START=$(date -d "7 days ago" +%Y-%m-%d)
        WEEK_END=$(date +%Y-%m-%d)

        # Prepare message
        {
          echo "ðŸ“ Weekly Summary: ${WEEK_START} - ${WEEK_END}"
          echo ""
          cat /tmp/summary.md
        } > /tmp/message.txt

        # Telegram has 4096 char limit, truncate if needed
        head -c 4000 /tmp/message.txt > /tmp/message_truncated.txt

        # Send using JSON payload for proper encoding
        jq -n --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$(cat /tmp/message_truncated.txt)" \
              '{chat_id: $chat_id, text: $text}' | \
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -H "Content-Type: application/json" \
          -d @-
