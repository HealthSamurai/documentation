# Authorization Code Grant

The Authorization Code Grant ****is an OAuth 2.0 flow that regular web apps use in order to access an API, typically as Web  applications with backend and frontend. For more detailed information read [OAuth2.0 specifcation](https://tools.ietf.org/html/rfc6749#section-4.1).

## Authorization Request

The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint. The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted \(or denied\).

{% api-method method="get" host="\[base\]" path="/oauth2/authorize" %}
{% api-method-summary %}
Authorization Endpoint
{% endapi-method-summary %}

{% api-method-description %}
Initiate Authorization Code flow
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-query-parameters %}
{% api-method-parameter name="state" type="string" required=false %}
An opaque value used by the client to maintain state between the request and callback.
{% endapi-method-parameter %}

{% api-method-parameter name="scope" type="string" required=false %}
The scope of the request. If you want use OpenID Connect, value must contain `openid`. 
{% endapi-method-parameter %}

{% api-method-parameter name="response\_type" type="string" required=true %}
Value MUST be set to `code`. If you want use OpenID Connect and get `id_token` , value must be set to `id_token code`
{% endapi-method-parameter %}

{% api-method-parameter name="client\_id" type="string" required=true %}
Id of Client
{% endapi-method-parameter %}

{% api-method-parameter name="redirect\_uri" type="string" required=false %}
Client `redirect_uri`, if not presented, authorization server will redirect to the first `redirect_uri` described in client
{% endapi-method-parameter %}
{% endapi-method-query-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}
Html page with ResourceOwner authorization form
{% endapi-method-response-example-description %}

```






```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

### Example

Example of authorization URL for client `web-app`, and use OpenID.

```bash
GET http://localhost:8888/oauth2/authorize?
    response_type=code id_token
    &client_id=web-app
    &redirect_uri=http://localhost:4200
```

Should return authentication page

![Resource Owner authentication page](../../.gitbook/assets/screen-shot-2018-10-24-at-16.50.32.png)

### Response

Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier \(in the request or during client registration\). The redirection URI includes an authorization code and any local state provided by the client earlier.

#### Response Query parameters

| Parameter | Description |
| :--- | :--- |
| code | The authorization code generated by the authorization server. |
| state | The exact value received from the client. |

#### **Example:**

```text
http://localhost:4200/?code=ebf396a8-1c00-47ec-acdf-dd5771edcb3d
```

## Access Token Request

The `client` requests an access token from the authorization server's token endpoint by including the authorization `code` received in the previous step. When making the request, the client authenticates with the authorization server. The client includes the redirection URI used to obtain the authorization code for verification.

[Aidbox](https://www.health-samurai.io/aidbox) OAuth module support Authorization Code flow Access Token Request in two formats. First- Strict adherence to OAuth2.0 specifications for better compatibility. Second - JSON request as a more modern and simple way. Read official [OAuth2.0 specification](https://tools.ietf.org/html/rfc6749#section-4.1.3) for more details.

## JSON Request

In JSON Request you need specify `client_id`, `client_secret` ,  `grant_type` ,  `code`  and `redirect_uri` . 

{% api-method method="post" host="\[base\]" path="/oauth2/token" %}
{% api-method-summary %}
Token Endpoint
{% endapi-method-summary %}

{% api-method-description %}
Get `access_access` token via Authorization Code Grant.
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-body-parameters %}
{% api-method-parameter name="redirect\_uri" type="string" required=false %}
REQUIRED if specified in previous step
{% endapi-method-parameter %}

{% api-method-parameter name="grant\_type" type="string" required=true %}
Value MUST be set to `authorization_code`
{% endapi-method-parameter %}

{% api-method-parameter name="client\_secret" type="string" required=true %}
Client secret
{% endapi-method-parameter %}

{% api-method-parameter name="client\_id" type="string" required=true %}
Client Id
{% endapi-method-parameter %}

{% api-method-parameter name="code" type="string" required=true %}
`code` from previous step
{% endapi-method-parameter %}
{% endapi-method-body-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}
Return access\_token
{% endapi-method-response-example-description %}

```javascript
{
    "access_token": "cd97340505f2-42c4-4267-a472-cd97340505f2",
    "token_type": "bearer",
    "id_token": "dfs...adf.sdfa...dsf.asd...fasdf"
}
```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

### Example

{% tabs %}
{% tab title="Request" %}
```bash
curl -X POST \
  http://localhost:8888/oauth2/token \
  -H 'content-type: application/json' \
  -d '{"client_id":"web-app","client_secret":"client-secret", 
       "code": "ebf396a8-1c00-47ec-acdf-dd5771edcb3d", 
       "grant_type":"authorization_code"}'
```
{% endtab %}

{% tab title="Response" %}
```javascript
STATUS: 200
{
    "access_token": "cd97340505f2-42c4-4267-a472-cd97340505f2",
    "token_type": "bearer",
    "id_token": "dfs...adf.sdfa...dsf.asd...fasdf"
}
```
{% endtab %}
{% endtabs %}

## OAuth2.0 RFC Specification

As described in [OAuth2.0 specification](https://tools.ietf.org/html/rfc6749#section-4.1.3) client credentials  should be presented via Authorization Basic header, and `body` should be in `application/x-www-form-urlencoded` format  and contain `grant_type` , `code` and `redirect_uri` parameter. `grant_type` parameter value MUST be set to `authorization_code`.

{% api-method method="post" host="\[base\]" path="/oauth2/token" %}
{% api-method-summary %}
Token Endpoint
{% endapi-method-summary %}

{% api-method-description %}
Get `access_token` via Authorization Code Grant
{% endapi-method-description %}

{% api-method-spec %}
{% api-method-request %}
{% api-method-headers %}
{% api-method-parameter name="Content-Type" type="string" required=true %}
application/x-www-form-urlencoded
{% endapi-method-parameter %}

{% api-method-parameter name="Authorization" type="string" required=true %}
Basic credentials of client
{% endapi-method-parameter %}
{% endapi-method-headers %}

{% api-method-form-data-parameters %}
{% api-method-parameter name="grant\_type" type="string" required=true %}
Value MUST be set to `authorization_code`
{% endapi-method-parameter %}

{% api-method-parameter name="code" type="string" required=true %}
code from previous step
{% endapi-method-parameter %}

{% api-method-parameter name="redirect\_uri" type="string" required=false %}
REQUIRED if specified in previous step
{% endapi-method-parameter %}
{% endapi-method-form-data-parameters %}
{% endapi-method-request %}

{% api-method-response %}
{% api-method-response-example httpCode=200 %}
{% api-method-response-example-description %}
Return `access_token`
{% endapi-method-response-example-description %}

```javascript
{
    "access_token": "f2a3c18c-42c4-4267-a472-cd97340505f2",
    "token_type": "bearer"
}
```
{% endapi-method-response-example %}
{% endapi-method-response %}
{% endapi-method-spec %}
{% endapi-method %}

### Example

{% tabs %}
{% tab title="Request" %}
```bash
curl -X POST \
  http://localhost:8888/oauth2/token \
  -H 'Authorization: Basic d2ViLWFwcDpjbGllbnQtc2VjcmV0' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'grant_type=authorization_code
      &code=ebf396a8-1c00-47ec-acdf-dd5771edcb3d'
```
{% endtab %}

{% tab title="Response" %}
```javascript
SSTATUS: 200
{
    "access_token": "cd97340505f2-42c4-4267-a472-cd97340505f2",
    "token_type": "bearer",
    "id_token": "dfs...adf.sdfa...dsf.asd...fasdf"
}
```
{% endtab %}
{% endtabs %}

